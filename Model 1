#Model 1

#Goal: visualize the WLG by mean level of satisfaction in a country

#Calculate the winner lose gap for satisfactuib

#Mean satisfaction per country
cntrystfm <- aggregate(x = ESS.subset$stfdem.rc, by = list(ESS.subset$cntry), FUN = mean, na.rm = T)

#Idea 1: Mean of WLG in SWD is defined as the difference between the mean of satisfation WD for winners and the mean of satisaction WD for losers 

#Merge ESS subset and the WLG recoded subset

#Create Index
ESS.subsetWLG$ID <- seq.int(nrow(ESS.subsetWLG))
ESS.subset$ID <- seq.int(nrow(ESS.subset))

#Merge the dataset and clean
ESS.ready <- merge(x=ESS.subset, y=ESS.subsetWLG, by=c("ID"))
ESS.ready <- subset(ESS.ready, select = - c(cntry.y))

#Mean of SWD per country per W/L
cntrystfm <- aggregate(x = mean(stfdem), by = list(ESS.ready$cntry.x, ESS.ready$), FUN = mean, na.rm = T)

#Took me almost two hours to come up with this so please appreciate. However, CZ is missing (recoding for WLG did not work). I suggest we leave it out and ask the prof what happened with this puppy.

library(tidyr)
library(dplyr)

new <- ESS.ready %>% 
  pivot_longer(cols = starts_with('prtv'), values_to = 'winner_loser') %>%
  group_by(cntry.x, winner_loser) %>%
  summarise(mean_satisfaction = mean(stfdem.rc,na.rm = T))
new <- na.omit(new)

#Dataframe with the pure WLG
winner <- new %>% filter(winner_loser==1)
loser <- new %>% filter(winner_loser==0) 

WLG.list <- winner$mean_satisfaction-loser$mean_satisfaction
WLG.df.pre <- data.frame(matrix(unlist(WLG.list), nrow=length(WLG.list), byrow=TRUE))
colnames(WLG.df.pre) <- "WLG"

WLF.df <- cbind(WLG.df.pre$WLG,winner$cntry.x)
WLF.df <- as.data.frame(WLF.df)
WLF.df %>% rename(WLG = V1,cntry = V2)
  
#Visualization

library(ggplot2)
library(dplyr)
library(forcats)

data <- data.frame(wlg = rnorm(100, 3, 1))
data$country <- sample(rep(c("Italy", "Swiss", "Germany", "France", "Austria"),20))

data %>%
  mutate(country = fct_reorder(country, wlg, .fun='mean' )) %>%
  ggplot( aes(x=reorder(country, wlg), y=wlg, fill="grey")) + 
  geom_boxplot(width=0, outlier.shape = NA) +
  stat_summary(fun=mean, geom="point", shape=20, size=3, color="darkolivegreen3", fill="darkolivegreen3") +
  xlab(NULL) +
  ylab(NULL) +
  theme(legend.position="none") +
  ylim(2,8) +
  theme(axis.text.x = element_text(angle = 90),
        plot.background = element_rect(fill = 'white', colour = 'white'),
        panel.background = element_rect(fill = 'white', colour = 'white'),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "darkgrey"),
        axis.ticks = element_line(colour = "darkgrey")
        )+
  geom_hline(yintercept=c(4,7), alpha=0.6, col="black")+
  geom_hline(yintercept=c(6), alpha=0.6, col="darkgrey")+
  geom_hline(yintercept=c(3,5,8), alpha=0.3, col="darkgrey")

